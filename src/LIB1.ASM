;----------------------------- ASSEMBLER SOURCE -----------------------------
;Name            :
;Author          :
;Last update     :
;Action          :
;
;
;Using Libraries             :
;Using external files/macros :
;
;Notes :
;
;
;----------------------------------------------------------------------------

ASSUME cs : Code1, ds : MainData

include         bwsb.inc
include         gdmtype.inc

PUBLIC        SinTabl, StartTime, NewX, NewZ, LastTime, Handle, ModHead
PUBLIC        OldIntSeg, OldIntOffs
PUBLIC        AmbientR, AmbientG, AmbientB, DiffuseR, DiffuseG, DiffuseB, SpecR, SpecG, SpecB, Shiny
PUBLIC        R_T, G_T, B_T, R_L, G_L, B_L, NoSound, FOffsets

MainData      SEGMENT PUBLIC
EXTRN           Palette : BYTE

;----------------------------------------------------------------------------
;The sinus table for angles in 1 - 360 degrees. All values are multiplied
;by 256 to save decimals.
;----------------------------------------------------------------------------

SinTabl         DW   0 ,  1 ,  1 ,  2 ,  2 ,  3 ,  3 ,  4 ,  4 ,  5 ,  6 ,  6 ,  7 ,  7 ,  8 ,  8
                DW   9 ,  9 , 10 , 11 , 11 , 12 , 12 , 13 , 13 , 14 , 15 , 15 , 16 , 16 , 17 , 17
                DW  18 , 18 , 19 , 20 , 20 , 21 , 21 , 22 , 22 , 23 , 23 , 24 , 25 , 25 , 26 , 26
                DW  27 , 27 , 28 , 28 , 29 , 30 , 30 , 31 , 31 , 32 , 32 , 33 , 33 , 34 , 35 , 35
                DW  36 , 36 , 37 , 37 , 38 , 38 , 39 , 39 , 40 , 41 , 41 , 42 , 42 , 43 , 43 , 44
                DW  44 , 45 , 46 , 46 , 47 , 47 , 48 , 48 , 49 , 49 , 50 , 50 , 51 , 52 , 52 , 53
                DW  53 , 54 , 54 , 55 , 55 , 56 , 56 , 57 , 58 , 58 , 59 , 59 , 60 , 60 , 61 , 61
                DW  62 , 62 , 63 , 64 , 64 , 65 , 65 , 66 , 66 , 67 , 67 , 68 , 68 , 69 , 69 , 70
                DW  71 , 71 , 72 , 72 , 73 , 73 , 74 , 74 , 75 , 75 , 76 , 76 , 77 , 78 , 78 , 79
                DW  79 , 80 , 80 , 81 , 81 , 82 , 82 , 83 , 83 , 84 , 84 , 85 , 85 , 86 , 87 , 87
                DW  88 , 88 , 89 , 89 , 90 , 90 , 91 , 91 , 92 , 92 , 93 , 93 , 94 , 94 , 95 , 95
                DW  96 , 96 , 97 , 97 , 98 , 98 , 99 ,100 ,100 ,101 ,101 ,102 ,102 ,103 ,103 ,104
                DW 104 ,105 ,105 ,106 ,106 ,107 ,107 ,108 ,108 ,109 ,109 ,110 ,110 ,111 ,111 ,112
                DW 112 ,113 ,113 ,114 ,114 ,115 ,115 ,116 ,116 ,117 ,117 ,118 ,118 ,119 ,119 ,120
                DW 120 ,121 ,121 ,122 ,122 ,123 ,123 ,124 ,124 ,125 ,125 ,126 ,126 ,127 ,127 ,128
                DW 128 ,128 ,129 ,129 ,130 ,130 ,131 ,131 ,132 ,132 ,133 ,133 ,134 ,134 ,135 ,135
                DW 136 ,136 ,137 ,137 ,138 ,138 ,138 ,139 ,139 ,140 ,140 ,141 ,141 ,142 ,142 ,143
                DW 143 ,144 ,144 ,145 ,145 ,145 ,146 ,146 ,147 ,147 ,148 ,148 ,149 ,149 ,150 ,150
                DW 150 ,151 ,151 ,152 ,152 ,153 ,153 ,154 ,154 ,155 ,155 ,155 ,156 ,156 ,157 ,157
                DW 158 ,158 ,158 ,159 ,159 ,160 ,160 ,161 ,161 ,162 ,162 ,162 ,163 ,163 ,164 ,164
                DW 165 ,165 ,165 ,166 ,166 ,167 ,167 ,168 ,168 ,168 ,169 ,169 ,170 ,170 ,170 ,171
                DW 171 ,172 ,172 ,173 ,173 ,173 ,174 ,174 ,175 ,175 ,175 ,176 ,176 ,177 ,177 ,177
                DW 178 ,178 ,179 ,179 ,179 ,180 ,180 ,181 ,181 ,181 ,182 ,182 ,183 ,183 ,183 ,184
                DW 184 ,185 ,185 ,185 ,186 ,186 ,186 ,187 ,187 ,188 ,188 ,188 ,189 ,189 ,189 ,190
                DW 190 ,191 ,191 ,191 ,192 ,192 ,192 ,193 ,193 ,194 ,194 ,194 ,195 ,195 ,195 ,196
                DW 196 ,196 ,197 ,197 ,198 ,198 ,198 ,199 ,199 ,199 ,200 ,200 ,200 ,201 ,201 ,201
                DW 202 ,202 ,202 ,203 ,203 ,203 ,204 ,204 ,204 ,205 ,205 ,205 ,206 ,206 ,206 ,207
                DW 207 ,207 ,208 ,208 ,208 ,209 ,209 ,209 ,210 ,210 ,210 ,211 ,211 ,211 ,212 ,212
                DW 212 ,213 ,213 ,213 ,213 ,214 ,214 ,214 ,215 ,215 ,215 ,216 ,216 ,216 ,217 ,217
                DW 217 ,217 ,218 ,218 ,218 ,219 ,219 ,219 ,219 ,220 ,220 ,220 ,221 ,221 ,221 ,221
                DW 222 ,222 ,222 ,223 ,223 ,223 ,223 ,224 ,224 ,224 ,224 ,225 ,225 ,225 ,226 ,226
                DW 226 ,226 ,227 ,227 ,227 ,227 ,228 ,228 ,228 ,228 ,229 ,229 ,229 ,229 ,230 ,230
                DW 230 ,230 ,231 ,231 ,231 ,231 ,232 ,232 ,232 ,232 ,232 ,233 ,233 ,233 ,233 ,234
                DW 234 ,234 ,234 ,235 ,235 ,235 ,235 ,235 ,236 ,236 ,236 ,236 ,237 ,237 ,237 ,237
                DW 237 ,238 ,238 ,238 ,238 ,238 ,239 ,239 ,239 ,239 ,239 ,240 ,240 ,240 ,240 ,240
                DW 241 ,241 ,241 ,241 ,241 ,242 ,242 ,242 ,242 ,242 ,242 ,243 ,243 ,243 ,243 ,243
                DW 243 ,244 ,244 ,244 ,244 ,244 ,244 ,245 ,245 ,245 ,245 ,245 ,245 ,246 ,246 ,246
                DW 246 ,246 ,246 ,247 ,247 ,247 ,247 ,247 ,247 ,247 ,248 ,248 ,248 ,248 ,248 ,248
                DW 248 ,249 ,249 ,249 ,249 ,249 ,249 ,249 ,249 ,250 ,250 ,250 ,250 ,250 ,250 ,250
                DW 250 ,251 ,251 ,251 ,251 ,251 ,251 ,251 ,251 ,251 ,252 ,252 ,252 ,252 ,252 ,252
                DW 252 ,252 ,252 ,252 ,252 ,253 ,253 ,253 ,253 ,253 ,253 ,253 ,253 ,253 ,253 ,253
                DW 254 ,254 ,254 ,254 ,254 ,254 ,254 ,254 ,254 ,254 ,254 ,254 ,254 ,254 ,254 ,255
                DW 255 ,255 ,255 ,255 ,255 ,255 ,255 ,255 ,255 ,255 ,255 ,255 ,255 ,255 ,255 ,255
                DW 255 ,255 ,255 ,255 ,256 ,256 ,256 ,256 ,256 ,256 ,256 ,256 ,256 ,256 ,256 ,256
                DW 256 ,256 ,256 ,256 ,256 ,256 ,256 ,256 ,256 ,256 ,256 ,256 ,256 ,256 ,256 ,256
                DW 256 ,256 ,256 ,256 ,256 ,256 ,256 ,256 ,256 ,256 ,256 ,256 ,256 ,256 ,256 ,256
                DW 256 ,256 ,256 ,256 ,256 ,256 ,256 ,256 ,256 ,256 ,256 ,256 ,256 ,255 ,255 ,255
                DW 255 ,255 ,255 ,255 ,255 ,255 ,255 ,255 ,255 ,255 ,255 ,255 ,255 ,255 ,255 ,255
                DW 255 ,255 ,254 ,254 ,254 ,254 ,254 ,254 ,254 ,254 ,254 ,254 ,254 ,254 ,254 ,254
                DW 254 ,253 ,253 ,253 ,253 ,253 ,253 ,253 ,253 ,253 ,253 ,253 ,252 ,252 ,252 ,252
                DW 252 ,252 ,252 ,252 ,252 ,252 ,252 ,251 ,251 ,251 ,251 ,251 ,251 ,251 ,251 ,251
                DW 250 ,250 ,250 ,250 ,250 ,250 ,250 ,250 ,249 ,249 ,249 ,249 ,249 ,249 ,249 ,249
                DW 248 ,248 ,248 ,248 ,248 ,248 ,248 ,247 ,247 ,247 ,247 ,247 ,247 ,247 ,246 ,246
                DW 246 ,246 ,246 ,246 ,245 ,245 ,245 ,245 ,245 ,245 ,244 ,244 ,244 ,244 ,244 ,244
                DW 243 ,243 ,243 ,243 ,243 ,243 ,242 ,242 ,242 ,242 ,242 ,242 ,241 ,241 ,241 ,241
                DW 241 ,240 ,240 ,240 ,240 ,240 ,239 ,239 ,239 ,239 ,239 ,238 ,238 ,238 ,238 ,238
                DW 237 ,237 ,237 ,237 ,237 ,236 ,236 ,236 ,236 ,235 ,235 ,235 ,235 ,235 ,234 ,234
                DW 234 ,234 ,233 ,233 ,233 ,233 ,232 ,232 ,232 ,232 ,232 ,231 ,231 ,231 ,231 ,230
                DW 230 ,230 ,230 ,229 ,229 ,229 ,229 ,228 ,228 ,228 ,228 ,227 ,227 ,227 ,227 ,226
                DW 226 ,226 ,226 ,225 ,225 ,225 ,224 ,224 ,224 ,224 ,223 ,223 ,223 ,223 ,222 ,222
                DW 222 ,221 ,221 ,221 ,221 ,220 ,220 ,220 ,219 ,219 ,219 ,219 ,218 ,218 ,218 ,217
                DW 217 ,217 ,217 ,216 ,216 ,216 ,215 ,215 ,215 ,214 ,214 ,214 ,213 ,213 ,213 ,213
                DW 212 ,212 ,212 ,211 ,211 ,211 ,210 ,210 ,210 ,209 ,209 ,209 ,208 ,208 ,208 ,207
                DW 207 ,207 ,206 ,206 ,206 ,205 ,205 ,205 ,204 ,204 ,204 ,203 ,203 ,203 ,202 ,202
                DW 202 ,201 ,201 ,201 ,200 ,200 ,200 ,199 ,199 ,199 ,198 ,198 ,198 ,197 ,197 ,196
                DW 196 ,196 ,195 ,195 ,195 ,194 ,194 ,194 ,193 ,193 ,192 ,192 ,192 ,191 ,191 ,191
                DW 190 ,190 ,189 ,189 ,189 ,188 ,188 ,188 ,187 ,187 ,186 ,186 ,186 ,185 ,185 ,185
                DW 184 ,184 ,183 ,183 ,183 ,182 ,182 ,181 ,181 ,181 ,180 ,180 ,179 ,179 ,179 ,178
                DW 178 ,177 ,177 ,177 ,176 ,176 ,175 ,175 ,175 ,174 ,174 ,173 ,173 ,173 ,172 ,172
                DW 171 ,171 ,170 ,170 ,170 ,169 ,169 ,168 ,168 ,168 ,167 ,167 ,166 ,166 ,165 ,165
                DW 165 ,164 ,164 ,163 ,163 ,162 ,162 ,162 ,161 ,161 ,160 ,160 ,159 ,159 ,158 ,158
                DW 158 ,157 ,157 ,156 ,156 ,155 ,155 ,155 ,154 ,154 ,153 ,153 ,152 ,152 ,151 ,151
                DW 150 ,150 ,150 ,149 ,149 ,148 ,148 ,147 ,147 ,146 ,146 ,145 ,145 ,145 ,144 ,144
                DW 143 ,143 ,142 ,142 ,141 ,141 ,140 ,140 ,139 ,139 ,138 ,138 ,138 ,137 ,137 ,136
                DW 136 ,135 ,135 ,134 ,134 ,133 ,133 ,132 ,132 ,131 ,131 ,130 ,130 ,129 ,129 ,128
                DW 128 ,128 ,127 ,127 ,126 ,126 ,125 ,125 ,124 ,124 ,123 ,123 ,122 ,122 ,121 ,121
                DW 120 ,120 ,119 ,119 ,118 ,118 ,117 ,117 ,116 ,116 ,115 ,115 ,114 ,114 ,113 ,113
                DW 112 ,112 ,111 ,111 ,110 ,110 ,109 ,109 ,108 ,108 ,107 ,107 ,106 ,106 ,105 ,105
                DW 104 ,104 ,103 ,103 ,102 ,102 ,101 ,101 ,100 ,100 , 99 , 98 , 98 , 97 , 97 , 96
                DW  96 , 95 , 95 , 94 , 94 , 93 , 93 , 92 , 92 , 91 , 91 , 90 , 90 , 89 , 89 , 88
                DW  88 , 87 , 87 , 86 , 85 , 85 , 84 , 84 , 83 , 83 , 82 , 82 , 81 , 81 , 80 , 80
                DW  79 , 79 , 78 , 78 , 77 , 76 , 76 , 75 , 75 , 74 , 74 , 73 , 73 , 72 , 72 , 71
                DW  71 , 70 , 69 , 69 , 68 , 68 , 67 , 67 , 66 , 66 , 65 , 65 , 64 , 64 , 63 , 62
                DW  62 , 61 , 61 , 60 , 60 , 59 , 59 , 58 , 58 , 57 , 56 , 56 , 55 , 55 , 54 , 54
                DW  53 , 53 , 52 , 52 , 51 , 50 , 50 , 49 , 49 , 48 , 48 , 47 , 47 , 46 , 46 , 45
                DW  44 , 44 , 43 , 43 , 42 , 42 , 41 , 41 , 40 , 39 , 39 , 38 , 38 , 37 , 37 , 36
                DW  36 , 35 , 35 , 34 , 33 , 33 , 32 , 32 , 31 , 31 , 30 , 30 , 29 , 28 , 28 , 27
                DW  27 , 26 , 26 , 25 , 25 , 24 , 23 , 23 , 22 , 22 , 21 , 21 , 20 , 20 , 19 , 18
                DW  18 , 17 , 17 , 16 , 16 , 15 , 15 , 14 , 13 , 13 , 12 , 12 , 11 , 11 , 10 ,  9
                DW   9 ,  8 ,  8 ,  7 ,  7 ,  6 ,  6 ,  5 ,  4 ,  4 ,  3 ,  3 ,  2 ,  2 ,  1 ,  1
                DW   0 , -1 , -1 , -2 , -2 , -3 , -3 , -4 , -4 , -5 , -6 , -6 , -7 , -7 , -8 , -8
                DW  -9 , -9 ,-10 ,-11 ,-11 ,-12 ,-12 ,-13 ,-13 ,-14 ,-15 ,-15 ,-16 ,-16 ,-17 ,-17
                DW -18 ,-18 ,-19 ,-20 ,-20 ,-21 ,-21 ,-22 ,-22 ,-23 ,-23 ,-24 ,-25 ,-25 ,-26 ,-26
                DW -27 ,-27 ,-28 ,-28 ,-29 ,-30 ,-30 ,-31 ,-31 ,-32 ,-32 ,-33 ,-33 ,-34 ,-35 ,-35
                DW -36 ,-36 ,-37 ,-37 ,-38 ,-38 ,-39 ,-39 ,-40 ,-41 ,-41 ,-42 ,-42 ,-43 ,-43 ,-44
                DW -44 ,-45 ,-46 ,-46 ,-47 ,-47 ,-48 ,-48 ,-49 ,-49 ,-50 ,-50 ,-51 ,-52 ,-52 ,-53
                DW -53 ,-54 ,-54 ,-55 ,-55 ,-56 ,-56 ,-57 ,-58 ,-58 ,-59 ,-59 ,-60 ,-60 ,-61 ,-61
                DW -62 ,-62 ,-63 ,-64 ,-64 ,-65 ,-65 ,-66 ,-66 ,-67 ,-67 ,-68 ,-68 ,-69 ,-69 ,-70
                DW -71 ,-71 ,-72 ,-72 ,-73 ,-73 ,-74 ,-74 ,-75 ,-75 ,-76 ,-76 ,-77 ,-78 ,-78 ,-79
                DW -79 ,-80 ,-80 ,-81 ,-81 ,-82 ,-82 ,-83 ,-83 ,-84 ,-84 ,-85 ,-85 ,-86 ,-87 ,-87
                DW -88 ,-88 ,-89 ,-89 ,-90 ,-90 ,-91 ,-91 ,-92 ,-92 ,-93 ,-93 ,-94 ,-94 ,-95 ,-95
                DW -96 ,-96 ,-97 ,-97 ,-98 ,-98 ,-99 ,-100 ,-100 ,-101 ,-101 ,-102 ,-102 ,-103 ,-103 ,-104
                DW -104 ,-105 ,-105 ,-106 ,-106 ,-107 ,-107 ,-108 ,-108 ,-109 ,-109 ,-110 ,-110 ,-111 ,-111 ,-112
                DW -112 ,-113 ,-113 ,-114 ,-114 ,-115 ,-115 ,-116 ,-116 ,-117 ,-117 ,-118 ,-118 ,-119 ,-119 ,-120
                DW -120 ,-121 ,-121 ,-122 ,-122 ,-123 ,-123 ,-124 ,-124 ,-125 ,-125 ,-126 ,-126 ,-127 ,-127 ,-128
                DW -128 ,-128 ,-129 ,-129 ,-130 ,-130 ,-131 ,-131 ,-132 ,-132 ,-133 ,-133 ,-134 ,-134 ,-135 ,-135
                DW -136 ,-136 ,-137 ,-137 ,-138 ,-138 ,-138 ,-139 ,-139 ,-140 ,-140 ,-141 ,-141 ,-142 ,-142 ,-143
                DW -143 ,-144 ,-144 ,-145 ,-145 ,-145 ,-146 ,-146 ,-147 ,-147 ,-148 ,-148 ,-149 ,-149 ,-150 ,-150
                DW -150 ,-151 ,-151 ,-152 ,-152 ,-153 ,-153 ,-154 ,-154 ,-155 ,-155 ,-155 ,-156 ,-156 ,-157 ,-157
                DW -158 ,-158 ,-158 ,-159 ,-159 ,-160 ,-160 ,-161 ,-161 ,-162 ,-162 ,-162 ,-163 ,-163 ,-164 ,-164
                DW -165 ,-165 ,-165 ,-166 ,-166 ,-167 ,-167 ,-168 ,-168 ,-168 ,-169 ,-169 ,-170 ,-170 ,-170 ,-171
                DW -171 ,-172 ,-172 ,-173 ,-173 ,-173 ,-174 ,-174 ,-175 ,-175 ,-175 ,-176 ,-176 ,-177 ,-177 ,-177
                DW -178 ,-178 ,-179 ,-179 ,-179 ,-180 ,-180 ,-181 ,-181 ,-181 ,-182 ,-182 ,-183 ,-183 ,-183 ,-184
                DW -184 ,-185 ,-185 ,-185 ,-186 ,-186 ,-186 ,-187 ,-187 ,-188 ,-188 ,-188 ,-189 ,-189 ,-189 ,-190
                DW -190 ,-191 ,-191 ,-191 ,-192 ,-192 ,-192 ,-193 ,-193 ,-194 ,-194 ,-194 ,-195 ,-195 ,-195 ,-196
                DW -196 ,-196 ,-197 ,-197 ,-198 ,-198 ,-198 ,-199 ,-199 ,-199 ,-200 ,-200 ,-200 ,-201 ,-201 ,-201
                DW -202 ,-202 ,-202 ,-203 ,-203 ,-203 ,-204 ,-204 ,-204 ,-205 ,-205 ,-205 ,-206 ,-206 ,-206 ,-207
                DW -207 ,-207 ,-208 ,-208 ,-208 ,-209 ,-209 ,-209 ,-210 ,-210 ,-210 ,-211 ,-211 ,-211 ,-212 ,-212
                DW -212 ,-213 ,-213 ,-213 ,-213 ,-214 ,-214 ,-214 ,-215 ,-215 ,-215 ,-216 ,-216 ,-216 ,-217 ,-217
                DW -217 ,-217 ,-218 ,-218 ,-218 ,-219 ,-219 ,-219 ,-219 ,-220 ,-220 ,-220 ,-221 ,-221 ,-221 ,-221
                DW -222 ,-222 ,-222 ,-223 ,-223 ,-223 ,-223 ,-224 ,-224 ,-224 ,-224 ,-225 ,-225 ,-225 ,-226 ,-226
                DW -226 ,-226 ,-227 ,-227 ,-227 ,-227 ,-228 ,-228 ,-228 ,-228 ,-229 ,-229 ,-229 ,-229 ,-230 ,-230
                DW -230 ,-230 ,-231 ,-231 ,-231 ,-231 ,-232 ,-232 ,-232 ,-232 ,-232 ,-233 ,-233 ,-233 ,-233 ,-234
                DW -234 ,-234 ,-234 ,-235 ,-235 ,-235 ,-235 ,-235 ,-236 ,-236 ,-236 ,-236 ,-237 ,-237 ,-237 ,-237
                DW -237 ,-238 ,-238 ,-238 ,-238 ,-238 ,-239 ,-239 ,-239 ,-239 ,-239 ,-240 ,-240 ,-240 ,-240 ,-240
                DW -241 ,-241 ,-241 ,-241 ,-241 ,-242 ,-242 ,-242 ,-242 ,-242 ,-242 ,-243 ,-243 ,-243 ,-243 ,-243
                DW -243 ,-244 ,-244 ,-244 ,-244 ,-244 ,-244 ,-245 ,-245 ,-245 ,-245 ,-245 ,-245 ,-246 ,-246 ,-246
                DW -246 ,-246 ,-246 ,-247 ,-247 ,-247 ,-247 ,-247 ,-247 ,-247 ,-248 ,-248 ,-248 ,-248 ,-248 ,-248
                DW -248 ,-249 ,-249 ,-249 ,-249 ,-249 ,-249 ,-249 ,-249 ,-250 ,-250 ,-250 ,-250 ,-250 ,-250 ,-250
                DW -250 ,-251 ,-251 ,-251 ,-251 ,-251 ,-251 ,-251 ,-251 ,-251 ,-252 ,-252 ,-252 ,-252 ,-252 ,-252
                DW -252 ,-252 ,-252 ,-252 ,-252 ,-253 ,-253 ,-253 ,-253 ,-253 ,-253 ,-253 ,-253 ,-253 ,-253 ,-253
                DW -254 ,-254 ,-254 ,-254 ,-254 ,-254 ,-254 ,-254 ,-254 ,-254 ,-254 ,-254 ,-254 ,-254 ,-254 ,-255
                DW -255 ,-255 ,-255 ,-255 ,-255 ,-255 ,-255 ,-255 ,-255 ,-255 ,-255 ,-255 ,-255 ,-255 ,-255 ,-255
                DW -255 ,-255 ,-255 ,-255 ,-256 ,-256 ,-256 ,-256 ,-256 ,-256 ,-256 ,-256 ,-256 ,-256 ,-256 ,-256
                DW -256 ,-256 ,-256 ,-256 ,-256 ,-256 ,-256 ,-256 ,-256 ,-256 ,-256 ,-256 ,-256 ,-256 ,-256 ,-256
                DW -256 ,-256 ,-256 ,-256 ,-256 ,-256 ,-256 ,-256 ,-256 ,-256 ,-256 ,-256 ,-256 ,-256 ,-256 ,-256
                DW -256 ,-256 ,-256 ,-256 ,-256 ,-256 ,-256 ,-256 ,-256 ,-256 ,-256 ,-256 ,-256 ,-255 ,-255 ,-255
                DW -255 ,-255 ,-255 ,-255 ,-255 ,-255 ,-255 ,-255 ,-255 ,-255 ,-255 ,-255 ,-255 ,-255 ,-255 ,-255
                DW -255 ,-255 ,-254 ,-254 ,-254 ,-254 ,-254 ,-254 ,-254 ,-254 ,-254 ,-254 ,-254 ,-254 ,-254 ,-254
                DW -254 ,-253 ,-253 ,-253 ,-253 ,-253 ,-253 ,-253 ,-253 ,-253 ,-253 ,-253 ,-252 ,-252 ,-252 ,-252
                DW -252 ,-252 ,-252 ,-252 ,-252 ,-252 ,-252 ,-251 ,-251 ,-251 ,-251 ,-251 ,-251 ,-251 ,-251 ,-251
                DW -250 ,-250 ,-250 ,-250 ,-250 ,-250 ,-250 ,-250 ,-249 ,-249 ,-249 ,-249 ,-249 ,-249 ,-249 ,-249
                DW -248 ,-248 ,-248 ,-248 ,-248 ,-248 ,-248 ,-247 ,-247 ,-247 ,-247 ,-247 ,-247 ,-247 ,-246 ,-246
                DW -246 ,-246 ,-246 ,-246 ,-245 ,-245 ,-245 ,-245 ,-245 ,-245 ,-244 ,-244 ,-244 ,-244 ,-244 ,-244
                DW -243 ,-243 ,-243 ,-243 ,-243 ,-243 ,-242 ,-242 ,-242 ,-242 ,-242 ,-242 ,-241 ,-241 ,-241 ,-241
                DW -241 ,-240 ,-240 ,-240 ,-240 ,-240 ,-239 ,-239 ,-239 ,-239 ,-239 ,-238 ,-238 ,-238 ,-238 ,-238
                DW -237 ,-237 ,-237 ,-237 ,-237 ,-236 ,-236 ,-236 ,-236 ,-235 ,-235 ,-235 ,-235 ,-235 ,-234 ,-234
                DW -234 ,-234 ,-233 ,-233 ,-233 ,-233 ,-232 ,-232 ,-232 ,-232 ,-232 ,-231 ,-231 ,-231 ,-231 ,-230
                DW -230 ,-230 ,-230 ,-229 ,-229 ,-229 ,-229 ,-228 ,-228 ,-228 ,-228 ,-227 ,-227 ,-227 ,-227 ,-226
                DW -226 ,-226 ,-226 ,-225 ,-225 ,-225 ,-224 ,-224 ,-224 ,-224 ,-223 ,-223 ,-223 ,-223 ,-222 ,-222
                DW -222 ,-221 ,-221 ,-221 ,-221 ,-220 ,-220 ,-220 ,-219 ,-219 ,-219 ,-219 ,-218 ,-218 ,-218 ,-217
                DW -217 ,-217 ,-217 ,-216 ,-216 ,-216 ,-215 ,-215 ,-215 ,-214 ,-214 ,-214 ,-213 ,-213 ,-213 ,-213
                DW -212 ,-212 ,-212 ,-211 ,-211 ,-211 ,-210 ,-210 ,-210 ,-209 ,-209 ,-209 ,-208 ,-208 ,-208 ,-207
                DW -207 ,-207 ,-206 ,-206 ,-206 ,-205 ,-205 ,-205 ,-204 ,-204 ,-204 ,-203 ,-203 ,-203 ,-202 ,-202
                DW -202 ,-201 ,-201 ,-201 ,-200 ,-200 ,-200 ,-199 ,-199 ,-199 ,-198 ,-198 ,-198 ,-197 ,-197 ,-196
                DW -196 ,-196 ,-195 ,-195 ,-195 ,-194 ,-194 ,-194 ,-193 ,-193 ,-192 ,-192 ,-192 ,-191 ,-191 ,-191
                DW -190 ,-190 ,-189 ,-189 ,-189 ,-188 ,-188 ,-188 ,-187 ,-187 ,-186 ,-186 ,-186 ,-185 ,-185 ,-185
                DW -184 ,-184 ,-183 ,-183 ,-183 ,-182 ,-182 ,-181 ,-181 ,-181 ,-180 ,-180 ,-179 ,-179 ,-179 ,-178
                DW -178 ,-177 ,-177 ,-177 ,-176 ,-176 ,-175 ,-175 ,-175 ,-174 ,-174 ,-173 ,-173 ,-173 ,-172 ,-172
                DW -171 ,-171 ,-170 ,-170 ,-170 ,-169 ,-169 ,-168 ,-168 ,-168 ,-167 ,-167 ,-166 ,-166 ,-165 ,-165
                DW -165 ,-164 ,-164 ,-163 ,-163 ,-162 ,-162 ,-162 ,-161 ,-161 ,-160 ,-160 ,-159 ,-159 ,-158 ,-158
                DW -158 ,-157 ,-157 ,-156 ,-156 ,-155 ,-155 ,-155 ,-154 ,-154 ,-153 ,-153 ,-152 ,-152 ,-151 ,-151
                DW -150 ,-150 ,-150 ,-149 ,-149 ,-148 ,-148 ,-147 ,-147 ,-146 ,-146 ,-145 ,-145 ,-145 ,-144 ,-144
                DW -143 ,-143 ,-142 ,-142 ,-141 ,-141 ,-140 ,-140 ,-139 ,-139 ,-138 ,-138 ,-138 ,-137 ,-137 ,-136
                DW -136 ,-135 ,-135 ,-134 ,-134 ,-133 ,-133 ,-132 ,-132 ,-131 ,-131 ,-130 ,-130 ,-129 ,-129 ,-128
                DW -128 ,-128 ,-127 ,-127 ,-126 ,-126 ,-125 ,-125 ,-124 ,-124 ,-123 ,-123 ,-122 ,-122 ,-121 ,-121
                DW -120 ,-120 ,-119 ,-119 ,-118 ,-118 ,-117 ,-117 ,-116 ,-116 ,-115 ,-115 ,-114 ,-114 ,-113 ,-113
                DW -112 ,-112 ,-111 ,-111 ,-110 ,-110 ,-109 ,-109 ,-108 ,-108 ,-107 ,-107 ,-106 ,-106 ,-105 ,-105
                DW -104 ,-104 ,-103 ,-103 ,-102 ,-102 ,-101 ,-101 ,-100 ,-100 ,-99 ,-98 ,-98 ,-97 ,-97 ,-96
                DW -96 ,-95 ,-95 ,-94 ,-94 ,-93 ,-93 ,-92 ,-92 ,-91 ,-91 ,-90 ,-90 ,-89 ,-89 ,-88
                DW -88 ,-87 ,-87 ,-86 ,-85 ,-85 ,-84 ,-84 ,-83 ,-83 ,-82 ,-82 ,-81 ,-81 ,-80 ,-80
                DW -79 ,-79 ,-78 ,-78 ,-77 ,-76 ,-76 ,-75 ,-75 ,-74 ,-74 ,-73 ,-73 ,-72 ,-72 ,-71
                DW -71 ,-70 ,-69 ,-69 ,-68 ,-68 ,-67 ,-67 ,-66 ,-66 ,-65 ,-65 ,-64 ,-64 ,-63 ,-62
                DW -62 ,-61 ,-61 ,-60 ,-60 ,-59 ,-59 ,-58 ,-58 ,-57 ,-56 ,-56 ,-55 ,-55 ,-54 ,-54
                DW -53 ,-53 ,-52 ,-52 ,-51 ,-50 ,-50 ,-49 ,-49 ,-48 ,-48 ,-47 ,-47 ,-46 ,-46 ,-45
                DW -44 ,-44 ,-43 ,-43 ,-42 ,-42 ,-41 ,-41 ,-40 ,-39 ,-39 ,-38 ,-38 ,-37 ,-37 ,-36
                DW -36 ,-35 ,-35 ,-34 ,-33 ,-33 ,-32 ,-32 ,-31 ,-31 ,-30 ,-30 ,-29 ,-28 ,-28 ,-27
                DW -27 ,-26 ,-26 ,-25 ,-25 ,-24 ,-23 ,-23 ,-22 ,-22 ,-21 ,-21 ,-20 ,-20 ,-19 ,-18
                DW -18 ,-17 ,-17 ,-16 ,-16 ,-15 ,-15 ,-14 ,-13 ,-13 ,-12 ,-12 ,-11 ,-11 ,-10 , -9
                DW  -9 , -8 , -8 , -7 , -7 , -6 , -6 , -5 , -4 , -4 , -3 , -3 , -2 , -2 , -1 , -1
                DW   0 ,  1 ,  1 ,  2 ,  2 ,  3 ,  3 ,  4 ,  4 ,  5 ,  6 ,  6 ,  7 ,  7 ,  8 ,  8
                DW   9 ,  9 , 10 , 11 , 11 , 12 , 12 , 13 , 13 , 14 , 15 , 15 , 16 , 16 , 17 , 17
                DW  18 , 18 , 19 , 20 , 20 , 21 , 21 , 22 , 22 , 23 , 23 , 24 , 25 , 25 , 26 , 26
                DW  27 , 27 , 28 , 28 , 29 , 30 , 30 , 31 , 31 , 32 , 32 , 33 , 33 , 34 , 35 , 35
                DW  36 , 36 , 37 , 37 , 38 , 38 , 39 , 39 , 40 , 41 , 41 , 42 , 42 , 43 , 43 , 44
                DW  44 , 45 , 46 , 46 , 47 , 47 , 48 , 48 , 49 , 49 , 50 , 50 , 51 , 52 , 52 , 53
                DW  53 , 54 , 54 , 55 , 55 , 56 , 56 , 57 , 58 , 58 , 59 , 59 , 60 , 60 , 61 , 61
                DW  62 , 62 , 63 , 64 , 64 , 65 , 65 , 66 , 66 , 67 , 67 , 68 , 68 , 69 , 69 , 70
                DW  71 , 71 , 72 , 72 , 73 , 73 , 74 , 74 , 75 , 75 , 76 , 76 , 77 , 78 , 78 , 79
                DW  79 , 80 , 80 , 81 , 81 , 82 , 82 , 83 , 83 , 84 , 84 , 85 , 85 , 86 , 87 , 87
                DW  88 , 88 , 89 , 89 , 90 , 90 , 91 , 91 , 92 , 92 , 93 , 93 , 94 , 94 , 95 , 95
                DW  96 , 96 , 97 , 97 , 98 , 98 , 99 ,100 ,100 ,101 ,101 ,102 ,102 ,103 ,103 ,104
                DW 104 ,105 ,105 ,106 ,106 ,107 ,107 ,108 ,108 ,109 ,109 ,110 ,110 ,111 ,111 ,112
                DW 112 ,113 ,113 ,114 ,114 ,115 ,115 ,116 ,116 ,117 ,117 ,118 ,118 ,119 ,119 ,120
                DW 120 ,121 ,121 ,122 ,122 ,123 ,123 ,124 ,124 ,125 ,125 ,126 ,126 ,127 ,127 ,128
                DW 128 ,128 ,129 ,129 ,130 ,130 ,131 ,131 ,132 ,132 ,133 ,133 ,134 ,134 ,135 ,135
                DW 136 ,136 ,137 ,137 ,138 ,138 ,138 ,139 ,139 ,140 ,140 ,141 ,141 ,142 ,142 ,143
                DW 143 ,144 ,144 ,145 ,145 ,145 ,146 ,146 ,147 ,147 ,148 ,148 ,149 ,149 ,150 ,150
                DW 150 ,151 ,151 ,152 ,152 ,153 ,153 ,154 ,154 ,155 ,155 ,155 ,156 ,156 ,157 ,157
                DW 158 ,158 ,158 ,159 ,159 ,160 ,160 ,161 ,161 ,162 ,162 ,162 ,163 ,163 ,164 ,164
                DW 165 ,165 ,165 ,166 ,166 ,167 ,167 ,168 ,168 ,168 ,169 ,169 ,170 ,170 ,170 ,171
                DW 171 ,172 ,172 ,173 ,173 ,173 ,174 ,174 ,175 ,175 ,175 ,176 ,176 ,177 ,177 ,177
                DW 178 ,178 ,179 ,179 ,179 ,180 ,180 ,181 ,181 ,181 ,182 ,182 ,183 ,183 ,183 ,184
                DW 184 ,185 ,185 ,185 ,186 ,186 ,186 ,187 ,187 ,188 ,188 ,188 ,189 ,189 ,189 ,190
                DW 190 ,191 ,191 ,191 ,192 ,192 ,192 ,193 ,193 ,194 ,194 ,194 ,195 ,195 ,195 ,196
                DW 196 ,196 ,197 ,197 ,198 ,198 ,198 ,199 ,199 ,199 ,200 ,200 ,200 ,201 ,201 ,201
                DW 202 ,202 ,202 ,203 ,203 ,203 ,204 ,204 ,204 ,205 ,205 ,205 ,206 ,206 ,206 ,207
                DW 207 ,207 ,208 ,208 ,208 ,209 ,209 ,209 ,210 ,210 ,210 ,211 ,211 ,211 ,212 ,212
                DW 212 ,213 ,213 ,213 ,213 ,214 ,214 ,214 ,215 ,215 ,215 ,216 ,216 ,216 ,217 ,217
                DW 217 ,217 ,218 ,218 ,218 ,219 ,219 ,219 ,219 ,220 ,220 ,220 ,221 ,221 ,221 ,221
                DW 222 ,222 ,222 ,223 ,223 ,223 ,223 ,224 ,224 ,224 ,224 ,225 ,225 ,225 ,226 ,226
                DW 226 ,226 ,227 ,227 ,227 ,227 ,228 ,228 ,228 ,228 ,229 ,229 ,229 ,229 ,230 ,230
                DW 230 ,230 ,231 ,231 ,231 ,231 ,232 ,232 ,232 ,232 ,232 ,233 ,233 ,233 ,233 ,234
                DW 234 ,234 ,234 ,235 ,235 ,235 ,235 ,235 ,236 ,236 ,236 ,236 ,237 ,237 ,237 ,237
                DW 237 ,238 ,238 ,238 ,238 ,238 ,239 ,239 ,239 ,239 ,239 ,240 ,240 ,240 ,240 ,240
                DW 241 ,241 ,241 ,241 ,241 ,242 ,242 ,242 ,242 ,242 ,242 ,243 ,243 ,243 ,243 ,243
                DW 243 ,244 ,244 ,244 ,244 ,244 ,244 ,245 ,245 ,245 ,245 ,245 ,245 ,246 ,246 ,246
                DW 246 ,246 ,246 ,247 ,247 ,247 ,247 ,247 ,247 ,247 ,248 ,248 ,248 ,248 ,248 ,248
                DW 248 ,249 ,249 ,249 ,249 ,249 ,249 ,249 ,249 ,250 ,250 ,250 ,250 ,250 ,250 ,250
                DW 250 ,251 ,251 ,251 ,251 ,251 ,251 ,251 ,251 ,251 ,252 ,252 ,252 ,252 ,252 ,252
                DW 252 ,252 ,252 ,252 ,252 ,253 ,253 ,253 ,253 ,253 ,253 ,253 ,253 ,253 ,253 ,253
                DW 254 ,254 ,254 ,254 ,254 ,254 ,254 ,254 ,254 ,254 ,254 ,254 ,254 ,254 ,254 ,255
                DW 255 ,255 ,255 ,255 ,255 ,255 ,255 ,255 ,255 ,255 ,255 ,255 ,255 ,255 ,255 ,255
                DW 255 ,255 ,255 ,255 ,256 ,256 ,256 ,256 ,256 ,256 ,256 ,256 ,256 ,256 ,256 ,256
                DW 256 ,256 ,256 ,256 ,256 ,256 ,256 ,256 ,256 ,256 ,256 ,256 ,256 ,256 ,256 ,256
                DW 256 ,256 ,256 ,256 ,256 ,256 ,256 ,256 ,256 ,256 ,256 ,256 ,256 ,256 ,256 ,256
                DW 256 ,256 ,256 ,256 ,256 ,256 ,256 ,256 ,256 ,256 ,256 ,256 ,256 ,255 ,255 ,255
                DW 255 ,255 ,255 ,255 ,255 ,255 ,255 ,255 ,255 ,255 ,255 ,255 ,255 ,255 ,255 ,255
                DW 255 ,255 ,254 ,254 ,254 ,254 ,254 ,254 ,254 ,254 ,254 ,254 ,254 ,254 ,254 ,254
                DW 254 ,253 ,253 ,253 ,253 ,253 ,253 ,253 ,253 ,253 ,253 ,253 ,252 ,252 ,252 ,252

X               DW 0                            ;
Y               DW 0                            ;
Z               DW 0                            ;Variables for procedure
X_Angle         DW 0                            ;"ROTATE"
Y_Angle         DW 0                            ;Storage variables for the
Z_Angle         DW 0                            ;input values
NewX            DW 0                            ;
NewY            DW 0                            ;
NewZ            DW 0                            ;

StartTime       DD 0
LastTime        DD 0
Handle          DW 0

ModHead         GDMHeader   <?>
NoSound         DB 0

OldIntSeg       DW 0
OldIntOffs      DW 0

;------------- PROC SetPhong
AmbientR        DB 15
AmbientG        DB 0
AmbientB        DB 5
DiffuseR        DB 20
DiffuseG        DB 0
DiffuseB        DB 15
SpecR           DB 5
SpecG           DB 0
SpecB           DB 5
Shiny           DB 10

;------------- PROC SetCol
R_T             DB 0
G_T             DB 0
B_T             DB 0
R_L             DW 0            *(2*2*2*2*2*2)
G_L             DW 0             *(2*2*2*2*2*2)
B_L             DW 00            *(2*2*2*2*2*2)

;------------ The offsets inside MAIN.DAT
FOffsets        DD 50, 12328, 23744, 35311, 45758, 392822, 425590, 458358
                DD 522358

MainData      ENDS

PUBLIC        Rotate, F3DTo2D, GetTimer, ViewPCX, SetPhong, SetCol

Code1         SEGMENT PUBLIC
.386

;ds:si = offset compressed PCX
;es:di = offset to view picture

ViewPCX       PROC
                add   si, 128                   ;Dump PCX-header
PCXLoop:
                lodsb
                cmp   al, 192
                ja    SevP
                stosb
                cmp   di, 64000
                jb    PCXLoop
                jmp   DonePCX
SevP:
                sub   al, 192
                movzx cx, al
                lodsb
                rep   stosb
                cmp   di, 64000
                jb    PCXLoop
DonePCX:
                ret
ViewPCX       ENDP

;----------------------------------------------------------------------------
;Name         : Rotate
;Type         : Procedure
;Last update  : Spring 1995
;Action       : Rotates a point around origo
;Optimized    : No. How do I a reduce the muls to 9???
;
;Input variables : ax = X   bx = Y   cx = Z
;                  dx = X_Angle si = Y_Angle di = Z_Angle
;
;Output variables : ax = NewX  bx = NewY  cx = NewZ
;
;Registers changed : ax, bx, cx
;
;Notes : Yes! Yes! Yes! At last : Rotating in assembler.
;----------------------------------------------------------------------------

Rotate        PROC
                pusha                           ;Save registers
                sal   ax, 2
                sal   bx, 2
                sal   cx, 2
                mov   X, ax                     ;Save coordinates
                mov   Y, bx                     ;
                mov   Z, cx                     ;

                shl   dx, 1
                shl   si, 1
                shl   di, 1

                mov   X_Angle, dx               ;Save angles
                mov   Y_Angle, si               ;
                mov   Z_Angle, di               ;


;----------------------------------------------------------------------------
;Let's rock around the X-axis first :
;----------------------------------------------------------------------------

                mov   si, dx                    ;Point to value [X_Angle]
                mov   cx, [si + (90*8*2) + OFFSET SinTabl]            ;Load cosinus(X_angle) in cx
                mov   bp, [si + OFFSET SinTabl]                  ;Load sinus(X_angle) in bp

                mov   ax, Y                     ;Put Y-coordinate in ax

                imul  cx                        ;Multiply Y with Cosvalue

                mov   al, ah                    ;Shift right by 8
                mov   ah, dl                    ;

                mov   di, ax                    ;Save ax in di

                mov   ax, Z                     ;Put Z-coordinate in ax

                imul  bp                        ;Multiply Z (ax) with Sinvalue

                mov   al, ah                    ;Shift right by 8
                mov   ah, dl

                sub   di, ax                    ;Done
                mov   NewY, di                  ;Save NewY

;----------------------------------------------------------------------------
;Done calculating the new Y-coordinate rotated X_Angle degrees
;----------------------------------------------------------------------------

                mov   ax, Y                     ;Put Y-coordinate in ax

                imul  bp                        ;Multiply Y (ax) with Sinvalue

                mov   al, ah                    ;Shift right by 8
                mov   ah, dl                    ;

                mov   di, ax                    ;Save ax in di

                mov   ax, Z

                imul  cx                        ;Multiply Z (ax) with Cosvalue

                mov   al, ah                    ;Shift right by 8
                mov   ah, dl                    ;

                add   di, ax
                mov   NewZ, di                  ;Save NewZ

;----------------------------------------------------------------------------
;Done calculating the new Z-coordinate rotated X_Angle degrees
;----------------------------------------------------------------------------

;----------------------------------------------------------------------------
;Let's swing the Y-axis :
;----------------------------------------------------------------------------

                mov   si, Y_Angle               ;Point to value [Z_Angle]
                mov   cx, [si + (90*8*2) + OFFSET SinTabl]            ;Load cosinus(Z_angle) in cx
                mov   bp, [si + OFFSET SinTabl]                  ;Load sinus(Z_angle) in bp

                mov   ax, NewZ                     ;Put Z-coordinate in ax

                imul  cx                        ;Multiply Z with Cosvalue

                mov   al, ah                    ;Shift right by 8
                mov   ah, dl                    ;

                mov   di, ax                    ;Save ax in di

                mov   ax, X                     ;Put X-coordinate in ax

                imul  bp                        ;Multiply X (ax) with Sinvalue

                mov   al, ah                    ;Shift right by 8
                mov   ah, dl

                sub   di, ax                    ;Done
                mov   ax, NewZ                  ;Put "old" Z-coordinate in ax
                                                ;cause I can't use the newly
                                                ;calculated Z-coordinate here
                mov   NewZ, di                  ;Save NewZ

;----------------------------------------------------------------------------
;Done calculating the new Z-coordinate rotated Y_Angle degrees
;----------------------------------------------------------------------------

                imul  bp                        ;Multiply Z (ax) with Sinvalue

                mov   al, ah                    ;Shift right by 8
                mov   ah, dl                    ;

                mov   di, ax                    ;Save ax in di

                mov   ax, X                     ;Put X-coordinate in ax

                imul  cx                        ;Multiply X (ax) with Cosvalue

                mov   al, ah                    ;Shift right by 8
                mov   ah, dl                    ;

                add   di, ax
                mov   NewX, di                  ;Save NewX

;----------------------------------------------------------------------------
;Done calculating the new X-coordinate rotated Y_Angle degrees
;----------------------------------------------------------------------------
;----------------------------------------------------------------------------
;Let's do the Z-axis :
;----------------------------------------------------------------------------

                mov   si, Z_Angle               ;Point si to the Cos-values
                mov   cx, [si + (90*8*2) + OFFSET SinTabl]            ;Load cosinus(Z_angle) in cx
                mov   bp, [si + OFFSET SinTabl]                  ;Load sinus(Z_angle) in bp

                mov   ax, NewX                  ;Put X-coordinate in ax

                imul  cx                        ;Multiply X with Cosvalue

                mov   al, ah                    ;Shift right by 8
                mov   ah, dl                    ;

                mov   di, ax                    ;Save ax in di

                mov   ax, NewY                  ;Put Y-coordinate in ax

                imul  bp                        ;Multiply Y (ax) with Sinvalue

                mov   al, ah                    ;Shift right by 8
                mov   ah, dl

                sub   di, ax
                mov   ax, NewX
                mov   NewX, di                  ;Save NewX

;----------------------------------------------------------------------------
;Done calculating the new X-coordinate rotated Z_Angle degrees
;----------------------------------------------------------------------------

;                mov   ax, NewY                  ;Put Y-coordinate in ax

                imul  bp                        ;Multiply Y (ax) with Cosvalue

                mov   al, ah                    ;Shift right by 8
                mov   ah, dl                    ;

                mov   di, ax
                mov   ax, NewY                     ;Load X-coordinate

                imul  cx                        ;Multiply X (ax) with Sinvalue

                mov   al, ah                    ;Shift right by 8
                mov   ah, dl                    ;

                add   di, ax
                mov   NewY, di                  ;Save NewY

;----------------------------------------------------------------------------
;Done calculating the new Y-coordinate rotated Z_Angle degrees
;----------------------------------------------------------------------------

                popa                            ;Load registers

                mov   ax, NewX                  ;Put the calculated
                mov   bx, NewY                  ;values back in to the
                mov   cx, NewZ                  ;registers
                sar   ax, 3
                sar   bx, 3
                sar   cx, 3

                ret

Rotate        ENDP


;----------------------------------------------------------------------------
;Name         : F3DTO2D
;Type         : Procedure
;Last update  : 20.10.1995
;Action       : Projects 3D-coordinates (X, Y, Z) into the visible
;               X, Y - coordinates for the screen.
;Optimized    : Yes
;
;Input variables : ax = X   bx = Y   cx = Z
;
;Output variables : ax = NewX bx = NewY
;
;Registers changed : ax, bx
;
;Notes : The coordinates are calculated using origo as center.
;----------------------------------------------------------------------------

F3DTo2D       PROC NEAR
                push  cx
                push  dx

                cwd
                mov   dl, ah                    ;\
                mov   ah, al
                xor   al, al

                idiv  cx                        ;dx:ax / cx

                xchg  ax, bx
                cwd
                mov   dl, ah
                mov   ah, al
                xor   al, al

                idiv  cx
                xchg  ax, bx

                pop   dx
                pop   cx

                ret                             ;Go home!
F3DTo2D       ENDP

;----------------------------------------------------------------------------
;Name         : GetTimer
;Type         : Procedure
;Last update  : 25.01.1996
;Action       : Gets a value from the timer with resolution of about 1/4100
;Optimized    : Yes
;
;Output variables : eax = timervalue
;
;Registers changed : eax
;
;Notes : ...
;----------------------------------------------------------------------------

GetTimer      PROC
                push dx
                mov  ah,0                  ;get tick count from Dos and use For hi 3 Bytes}
                int  01ah                  ;lo order count in DX, hi order in CX}

                mov  al, dh
                mov  ah, cl
                shl  eax, 16
                mov  ah, dl

                mov  al,0                  ;read lo Byte straight from timer chip}
                out  43h,al                ;latch count}
                mov  al,1
                out  43h,al              ;set up to read count}
                in   al,40h              ;read in lo Byte (and discard)}
                in   al,40h              ;hi Byte into al}
                neg  al                    ;make it so counting up instead of down}

                cmp  al, 0
                jnz  NoTimeFix
                add  eax, 00000100h
NoTimeFix:
                pop  dx
                ret
GetTimer      ENDP

SetPhong      PROC
                xor   bp, bp
PhCL:
                mov   bx, bp
                shl   bx, 4                     ;8*2 = 16
                mov   ax, [OFFSET SinTabl + (90*8*2) + bx]
                mov   bx, ax                    ;bx = Cos(Angle)

                movzx cx, Shiny
                cwd                             ;ax -> ax:dx
ShinyL:
                imul  bx
                shrd  ax, dx, 8
                loop  ShinyL
                mov   di, ax                    ;di = cos(Angle)^Shiny * 256

;----- Red
                movzx ax, DiffuseR
                imul  bx                        ;DiffuseR * Cos(Angle)
                shrd  ax, dx, 8
                mov   cx, ax                    ;cx = Diffuse-part
                movzx ax, SpecR
                imul  di                        ;SpecR * cos(Angle)^Shiny
                shr   ax, 8                     ;/256
                add   ax, cx
                add   al, AmbientR
                cmp   al, 63
                jb    ROK
                mov   al, 63
ROK:
                mov   [si], al

;----- Green
                movzx ax, DiffuseG
                imul  bx                        ;DiffuseG * Cos(Angle)
                shrd  ax, dx, 8
                mov   cx, ax                    ;cx = Diffuse-part
                movzx ax, SpecG
                imul  di                        ;SpecG * cos(Angle)^Shiny
                shr   ax, 8                     ;/256
                add   ax, cx
                add   al, AmbientG
                cmp   al, 63
                jb    GOK
                mov   al, 63
GOK:

                mov   [si + 1], al

;----- Blue
                movzx ax, DiffuseB
                imul  bx                        ;DiffuseB * Cos(Angle)
                shrd  ax, dx, 8
                mov   cx, ax                    ;cx = Diffuse-part
                movzx ax, SpecB
                imul  di                        ;SpecB * cos(Angle)^Shiny
                shr   ax, 8                     ;/256
                add   ax, cx
                add   al, AmbientB
                cmp   al, 63
                jb    BOK
                mov   al, 63
BOK:

                mov   [si + 2], al

                add   si, 3
                inc   bp
                cmp   bp, 90
                jbe   PhCL


                ret
SetPhong      ENDP

SetCol        PROC
;--------
                mov   si, OFFSET Palette

                mov   al, R_T
                mov   ah, G_T
                mov   bl, B_T
                shl   al, 2
                shl   ah, 2
                shl   bl, 2
                mov   cx, R_L
                mov   di, G_L
                mov   bp, B_L

                mov   bh, 15
SetPal1:
                movzx dx, al
                add   cx, dx
                movzx dx, ah
                add   di, dx
                movzx dx, bl
                add   bp, dx

                mov   dx, cx
                shr   dx, 6
                mov   BYTE PTR [si], dl         ;Red
                mov   dx, di
                shr   dx, 6
                mov   BYTE PTR [si + 1], dl     ;Green
                mov   dx, bp
                shr   dx, 6
                mov   BYTE PTR [si + 2], dl     ;Blue

                add   si, 3
                dec   bh
                jnz   SetPal1

                mov   bh, 15
SetPal2:
                movzx dx, al
                sub   cx, dx
                movzx dx, ah
                sub   di, dx
                movzx dx, bl
                sub   bp, dx

                mov   dx, cx
                shr   dx, 6
                mov   BYTE PTR [si], dl         ;Red
                mov   dx, di
                shr   dx, 6
                mov   BYTE PTR [si + 1], dl     ;Green
                mov   dx, bp
                shr   dx, 6
                mov   BYTE PTR [si + 2], dl     ;Blue

                add   si, 3
                dec   bh
                jnz   SetPal2

                mov   bh, 15
SetPal3:
                movzx dx, al
                add   cx, dx
                movzx dx, ah
                add   di, dx
                movzx dx, bl
                add   bp, dx

                mov   dx, cx
                shr   dx, 6
                mov   BYTE PTR [si], dl         ;Red
                mov   dx, di
                shr   dx, 6
                mov   BYTE PTR [si + 1], dl     ;Green
                mov   dx, bp
                shr   dx, 6
                mov   BYTE PTR [si + 2], dl     ;Blue

                add   si, 3
                dec   bh
                jnz   SetPal3

                mov   bh, 15
SetPal4:
                movzx dx, al
                sub   cx, dx
                movzx dx, ah
                sub   di, dx
                movzx dx, bl
                sub   bp, dx

                mov   dx, cx
                shr   dx, 6
                mov   BYTE PTR [si], dl         ;Red
                mov   dx, di
                shr   dx, 6
                mov   BYTE PTR [si + 1], dl     ;Green
                mov   dx, bp
                shr   dx, 6
                mov   BYTE PTR [si + 2], dl     ;Blue

                add   si, 3
                dec   bh
                jnz   SetPal4

;------------
                ret
SetCol        ENDP

Code1         ENDS

END
